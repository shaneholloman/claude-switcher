#!/bin/bash

# Claude Sessions Viewer
# Lists active Claude Code sessions with tracking information

# Source utils if available
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [ -f "$SCRIPT_DIR/claude-switcher-utils.sh" ]; then
    source "$SCRIPT_DIR/claude-switcher-utils.sh"
else
    BLUE='\033[0;34m'
    NC='\033[0m'
    print_status() { echo -e "${BLUE}[Claude Sessions]${NC} $1"; }
fi

echo ""
print_status "Found Claude Code processes:"
echo ""
printf "%-8s %-20s %-30s %-15s %-10s\n" "PID" "Mode" "Session ID" "Region" "Status"
printf "%-8s %-20s %-30s %-15s %-10s\n" "----" "----" "----------" "------" "------"

# Find actual Claude Code processes (not our wrapper scripts)
found_sessions=false

# Look for the actual 'claude' binary process
for pid in $(pgrep -x "claude" 2>/dev/null); do
    # Get process command line to check if it's not our scripts
    cmd=$(ps -p "$pid" -o command= 2>/dev/null)
    
    # Skip if it's one of our wrapper scripts
    if echo "$cmd" | grep -qE "claude-(pro|aws|vertex|anthropic|sessions|status)"; then
        continue
    fi
    
    found_sessions=true
    
    # Try to determine the mode by checking parent environment
    # Get the parent process ID
    ppid=$(ps -p "$pid" -o ppid= 2>/dev/null | tr -d ' ')
    
    mode="Unknown"
    session_id="N/A"
    region="N/A"
    
    # Check environment variables of the process if possible
    # On macOS, we can try to infer from parent or check ps output
    if [ -n "$ppid" ]; then
        parent_cmd=$(ps -p "$ppid" -o command= 2>/dev/null)
        
        # Detect mode from parent command
        if echo "$parent_cmd" | grep -q "claude-aws"; then
            mode="AWS Bedrock"
            region="us-west-2"  # Default, could be extracted from env
        elif echo "$parent_cmd" | grep -q "claude-vertex"; then
            mode="Vertex AI"
        elif echo "$parent_cmd" | grep -q "claude-anthropic"; then
            mode="Anthropic API"
        elif echo "$parent_cmd" | grep -q "claude-pro"; then
            mode="Claude Pro"
        fi
        
        # Try to extract session ID from parent env (if our scripts set it)
        # This is best-effort and may not work on all systems
        if echo "$parent_cmd" | grep -oE "(aws|vertex|anthropic|pro)-[0-9]+-[0-9]+" > /dev/null 2>&1; then
            session_id=$(echo "$parent_cmd" | grep -oE "(aws|vertex|anthropic|pro)-[0-9]+-[0-9]+" | head -1)
        fi
    fi
    
    printf "%-8s %-20s %-30s %-15s %-10s\n" "$pid" "$mode" "$session_id" "$region" "Running"
done

if [ "$found_sessions" = false ]; then
    echo ""
    print_status "No Claude sessions with session tracking found"
    print_status "Sessions started with claude-pro, claude-aws, claude-vertex, or claude-anthropic will appear here"
fi

echo ""
print_status "Commands:"
print_status "  claude-status   - Show current terminal's Claude configuration"
print_status "  claude-sessions - Show all active Claude sessions (this command)"
echo ""
