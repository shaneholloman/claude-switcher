#!/bin/bash

# Source utils
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/claude-switcher-utils.sh"

# Handle --version flag
if [[ "$1" == "--version" ]] || [[ "$1" == "-v" ]]; then
    echo "claude-switcher v$SWITCHER_VERSION"
    exit 0
fi

# Load config and secrets
load_config

# Generate unique session identifier
CLAUDE_SESSION_ID="aws-$$-$(date +%s)"
export CLAUDE_SESSION_ID

print_status "Switching to Claude AWS Bedrock mode..."
print_status "Session ID: $CLAUDE_SESSION_ID"

# Validate AWS Bedrock credentials
# Support three authentication methods:
# 1. AWS_BEARER_TOKEN_BEDROCK (API key)
# 2. AWS_ACCESS_KEY_ID + AWS_SECRET_ACCESS_KEY
# 3. AWS_PROFILE
AUTH_METHOD=""
if [ -n "$AWS_BEARER_TOKEN_BEDROCK" ]; then
    AUTH_METHOD="AWS Bearer Token"
elif [ -n "$AWS_ACCESS_KEY_ID" ] && [ -n "$AWS_SECRET_ACCESS_KEY" ]; then
    AUTH_METHOD="AWS Access Keys"
elif [ -n "$AWS_PROFILE" ]; then
    AUTH_METHOD="AWS Profile ($AWS_PROFILE)"
else
    print_error "No AWS credentials configured"
    print_error ""
    print_error "To use AWS Bedrock mode, configure one of the following in your secrets.sh:"
    print_error ""
    print_error "Option 1: AWS Bedrock API Key (recommended for simplicity)"
    print_error "  export AWS_BEARER_TOKEN_BEDROCK=\"your-bedrock-api-key\""
    print_error ""
    print_error "Option 2: AWS Access Keys"
    print_error "  export AWS_ACCESS_KEY_ID=\"your_access_key\""
    print_error "  export AWS_SECRET_ACCESS_KEY=\"your_secret_key\""
    print_error "  export AWS_SESSION_TOKEN=\"your_session_token\"  # Optional"
    print_error ""
    print_error "Option 3: AWS Profile"
    print_error "  export AWS_PROFILE=\"your-profile-name\""
    print_error ""
    print_error "All options require:"
    print_error "  export AWS_REGION=\"us-west-2\"  # or your preferred region"
    print_error ""
    print_error "See: https://code.claude.com/docs/en/amazon-bedrock"
    exit 1
fi

# Validate AWS region is set
if [ -z "$AWS_REGION" ]; then
    print_error "AWS_REGION is not set"
    print_error ""
    print_error "Please set AWS_REGION in your secrets.sh:"
    print_error "  export AWS_REGION=\"us-west-2\"  # or your preferred region"
    exit 1
fi

# Store existing environment variables to restore after Claude exits
SAVED_AWS_REGION="$AWS_REGION"
SAVED_ANTHROPIC_MODEL="$ANTHROPIC_MODEL"
SAVED_ANTHROPIC_SMALL_FAST_MODEL="$ANTHROPIC_SMALL_FAST_MODEL"
SAVED_CLAUDE_CODE_USE_BEDROCK="$CLAUDE_CODE_USE_BEDROCK"

# Enable Bedrock for current session
export CLAUDE_CODE_USE_BEDROCK=1

# Parse arguments to select model
# This sets ANTHROPIC_MODEL
parse_model_args "AWS" "$@"

# Remove model flags from arguments passed to claude
# We need to filter out --opus, --sonnet, --model <id>
# A simple way is to reconstruct args, but for now let's just assume
# the user might pass other flags to claude.
# The parse_model_args function consumes the model flags but doesn't remove them from $@.
# We need to actually shift them out or build a new array.
# Let's refine the approach: we will just pass all args to claude, 
# but claude might complain about unknown flags if we invented them.
# So we should strip them.

ARGS=()
while [[ $# -gt 0 ]]; do
    case $1 in
        --opus|--sonnet|--haiku)
            shift
            ;;
        --model)
            shift 2
            ;;
        *)
            ARGS+=("$1")
            shift
            ;;
    esac
done

print_success "Claude AWS Bedrock mode activated"
print_status "- Using AWS Bedrock API"
print_status "- Auth method: $AUTH_METHOD"
print_status "- Region: $AWS_REGION"
print_status "- Model: $ANTHROPIC_MODEL"
print_status "- Small/Fast Model: $ANTHROPIC_SMALL_FAST_MODEL"

print_status "Launching Claude Code..."

# Function to restore original environment variables
restore_environment() {
    print_status "Restoring original environment variables..."
    
    if [ -n "$SAVED_AWS_REGION" ]; then
        export AWS_REGION="$SAVED_AWS_REGION"
    else
        unset AWS_REGION
    fi
    
    if [ -n "$SAVED_ANTHROPIC_MODEL" ]; then
        export ANTHROPIC_MODEL="$SAVED_ANTHROPIC_MODEL"
    else
        unset ANTHROPIC_MODEL
    fi
    
    if [ -n "$SAVED_ANTHROPIC_SMALL_FAST_MODEL" ]; then
        export ANTHROPIC_SMALL_FAST_MODEL="$SAVED_ANTHROPIC_SMALL_FAST_MODEL"
    else
        unset ANTHROPIC_SMALL_FAST_MODEL
    fi
    
    if [ -n "$SAVED_CLAUDE_CODE_USE_BEDROCK" ]; then
        export CLAUDE_CODE_USE_BEDROCK="$SAVED_CLAUDE_CODE_USE_BEDROCK"
    else
        unset CLAUDE_CODE_USE_BEDROCK
    fi
    
    print_success "Environment restored"
}

trap restore_environment EXIT

# Launch Claude Code
claude "${ARGS[@]}"
