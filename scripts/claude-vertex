#!/bin/bash

# Source utils
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/claude-switcher-utils.sh"

# Handle --version flag
if [[ "$1" == "--version" ]] || [[ "$1" == "-v" ]]; then
    echo "claude-switcher v$SWITCHER_VERSION"
    exit 0
fi

# Load config and secrets
load_config

# Generate unique session identifier
CLAUDE_SESSION_ID="vertex-$$-$(date +%s)"
export CLAUDE_SESSION_ID

print_status "Switching to Claude Google Vertex AI mode..."
print_status "Session ID: $CLAUDE_SESSION_ID"

# Validate Google Cloud configuration
if [ -z "$ANTHROPIC_VERTEX_PROJECT_ID" ]; then
    print_error "ANTHROPIC_VERTEX_PROJECT_ID is not set"
    print_error ""
    print_error "To use Vertex AI mode, you need to:"
    print_error "  1. Set ANTHROPIC_VERTEX_PROJECT_ID in your secrets.sh file"
    print_error "  2. Set CLOUD_ML_REGION (e.g., global or us-east5) in your secrets.sh file"
    print_error "  3. Install Google Cloud SDK: https://cloud.google.com/sdk/docs/install"
    print_error "  4. Authenticate with: gcloud auth application-default login"
    print_error "  5. Enable Claude models in Vertex AI Model Garden"
    print_error ""
    print_error "Example secrets.sh:"
    print_error "  export ANTHROPIC_VERTEX_PROJECT_ID=\"your-gcp-project-id\""
    print_error "  export CLOUD_ML_REGION=\"global\""
    exit 1
fi

if [ -z "$CLOUD_ML_REGION" ]; then
    print_error "CLOUD_ML_REGION is not set"
    print_error ""
    print_error "Please set CLOUD_ML_REGION in your secrets.sh file."
    print_error "Example: export CLOUD_ML_REGION=\"global\""
    exit 1
fi

# Validate Google Cloud credentials
# Google Cloud authentication supports multiple methods with the following precedence:
# 1. GOOGLE_APPLICATION_CREDENTIALS (service account key file)
# 2. gcloud auth application-default credentials
# 3. gcloud auth login (user credentials)
#
# Per Google Cloud best practices, we check in this order:
AUTH_METHOD=""

if [ -n "$GOOGLE_APPLICATION_CREDENTIALS" ]; then
    # Method 1: Service account key file
    if [ -f "$GOOGLE_APPLICATION_CREDENTIALS" ]; then
        AUTH_METHOD="Service Account Key File"
        print_status "Using service account key: $GOOGLE_APPLICATION_CREDENTIALS"
    else
        print_error "GOOGLE_APPLICATION_CREDENTIALS is set but file not found: $GOOGLE_APPLICATION_CREDENTIALS"
        exit 1
    fi
elif [ -f "$HOME/.config/gcloud/application_default_credentials.json" ]; then
    # Method 2: Application Default Credentials
    AUTH_METHOD="Application Default Credentials"
    print_status "Using Application Default Credentials"
else
    # Method 3: gcloud auth login (user credentials)
    if ! command -v gcloud &> /dev/null; then
        print_error "gcloud CLI is not installed and GOOGLE_APPLICATION_CREDENTIALS is not set"
        print_error ""
        print_error "Please either:"
        print_error "  1. Set GOOGLE_APPLICATION_CREDENTIALS to point to a service account key file, OR"
        print_error "  2. Install Google Cloud SDK and authenticate:"
        print_error "     - Install: https://cloud.google.com/sdk/docs/install"
        print_error "     - Authenticate: gcloud auth application-default login"
        exit 1
    fi
    
    # Check if authenticated with gcloud
    gcloud_account=$(gcloud config get-value account 2>/dev/null)
    if [ -z "$gcloud_account" ]; then
        print_error "Not authenticated with Google Cloud and GOOGLE_APPLICATION_CREDENTIALS is not set"
        print_error ""
        print_error "Please either:"
        print_error "  1. Authenticate with: gcloud auth application-default login (recommended), OR"
        print_error "  2. Authenticate with: gcloud auth login, OR"
        print_error "  3. Set GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account-key.json"
        exit 1
    fi
    
    AUTH_METHOD="gcloud User Credentials ($gcloud_account)"
fi

# Store existing environment variables
SAVED_ANTHROPIC_MODEL="$ANTHROPIC_MODEL"
SAVED_ANTHROPIC_SMALL_FAST_MODEL="$ANTHROPIC_SMALL_FAST_MODEL"
SAVED_CLAUDE_CODE_USE_BEDROCK="$CLAUDE_CODE_USE_BEDROCK"
SAVED_CLAUDE_CODE_USE_VERTEX="$CLAUDE_CODE_USE_VERTEX"

# Disable Bedrock and enable Vertex
export CLAUDE_CODE_USE_BEDROCK=0
unset AWS_BEARER_TOKEN_BEDROCK

# Enable Vertex AI
export CLAUDE_CODE_USE_VERTEX=1

# Set Vertex AI environment variables
if [ -n "$ANTHROPIC_VERTEX_PROJECT_ID" ]; then
    export ANTHROPIC_VERTEX_PROJECT_ID
fi

if [ -n "$CLOUD_ML_REGION" ]; then
    export CLOUD_ML_REGION
fi

# Export all VERTEX_REGION_CLAUDE_* variables if they exist
for var in VERTEX_REGION_CLAUDE_3_5_SONNET VERTEX_REGION_CLAUDE_3_5_HAIKU \
           VERTEX_REGION_CLAUDE_3_7_SONNET VERTEX_REGION_CLAUDE_4_0_OPUS \
           VERTEX_REGION_CLAUDE_4_0_SONNET VERTEX_REGION_CLAUDE_4_1_OPUS \
           VERTEX_REGION_CLAUDE_4_5_SONNET; do
    if [ -n "${!var}" ]; then
        export $var
    fi
done

#Parse arguments to select model
parse_model_args "VERTEX" "$@"

# Strip our custom flags
ARGS=()
while [[ $# -gt 0 ]]; do
    case $1 in
        --opus|--sonnet|--haiku)
            shift
            ;;
        --model)
            shift 2
            ;;
        *)
            ARGS+=("$1")
            shift
            ;;
    esac
done

print_success "Claude Vertex AI mode activated"
print_status "- Using Google Vertex AI"
print_status "- Auth method: $AUTH_METHOD"
print_status "- Project: $ANTHROPIC_VERTEX_PROJECT_ID"
print_status "- Region: $CLOUD_ML_REGION"
print_status "- Model: $ANTHROPIC_MODEL"
print_status "- Small/Fast Model: $ANTHROPIC_SMALL_FAST_MODEL"

print_status "Launching Claude Code..."

restore_environment() {
    print_status "Restoring original environment variables..."
    
    if [ -n "$SAVED_ANTHROPIC_MODEL" ]; then
        export ANTHROPIC_MODEL="$SAVED_ANTHROPIC_MODEL"
    else
        unset ANTHROPIC_MODEL
    fi
    
    if [ -n "$SAVED_ANTHROPIC_SMALL_FAST_MODEL" ]; then
        export ANTHROPIC_SMALL_FAST_MODEL="$SAVED_ANTHROPIC_SMALL_FAST_MODEL"
    else
        unset ANTHROPIC_SMALL_FAST_MODEL
    fi
    
    if [ -n "$SAVED_CLAUDE_CODE_USE_BEDROCK" ]; then
        export CLAUDE_CODE_USE_BEDROCK="$SAVED_CLAUDE_CODE_USE_BEDROCK"
    else
        unset CLAUDE_CODE_USE_BEDROCK
    fi
    
    if [ -n "$SAVED_CLAUDE_CODE_USE_VERTEX" ]; then
        export CLAUDE_CODE_USE_VERTEX="$SAVED_CLAUDE_CODE_USE_VERTEX"
    else
        unset CLAUDE_CODE_USE_VERTEX
    fi
    
    print_success "Environment restored"
}

trap restore_environment EXIT

# Launch Claude Code
claude "${ARGS[@]}"
