#!/bin/bash

# Claude Status Script
# Shows current Claude Code configuration for all authentication methods

# Source utils
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/claude-switcher-utils.sh"

# Load config to ensure we see what the scripts see
load_config

echo ""
print_status "=== Claude Code Configuration Status ==="
echo ""

# Check API Key Helper configuration
CLAUDE_SETTINGS_FILE="$HOME/.claude/settings.json"
API_KEY_HELPER_SCRIPT="$HOME/.claude-switcher/claude-api-key-helper.sh"
CURRENT_MODE_FILE="$HOME/.claude-switcher/current-mode.sh"

print_status "API Key Helper Status:"

# Check if settings.json has apiKeyHelper configured
if [ -f "$CLAUDE_SETTINGS_FILE" ]; then
    if grep -q "apiKeyHelper" "$CLAUDE_SETTINGS_FILE" 2>/dev/null; then
        print_success "  settings.json: configured ✓"
    else
        print_warning "  settings.json: not configured"
        print_warning "  Run setup.sh to configure apiKeyHelper"
    fi
else
    print_warning "  settings.json: not found"
fi

# Check if helper script exists and is executable
if [ -f "$API_KEY_HELPER_SCRIPT" ]; then
    if [ -x "$API_KEY_HELPER_SCRIPT" ]; then
        print_success "  Helper script: exists and executable ✓"
    else
        print_warning "  Helper script: exists but not executable"
    fi
else
    print_warning "  Helper script: not found at $API_KEY_HELPER_SCRIPT"
fi

# Show current switcher mode
if [ -f "$CURRENT_MODE_FILE" ]; then
    source "$CURRENT_MODE_FILE"
    print_status "  Current switcher mode: ${CLAUDE_SWITCHER_MODE:-not set}"
else
    print_warning "  current-mode.sh: not found"
fi

echo ""

# Detect current authentication mode
mode="Unknown"
if [ "$CLAUDE_CODE_USE_BEDROCK" = "1" ] && [ -n "$AWS_BEARER_TOKEN_BEDROCK" ]; then
    mode="AWS Bedrock"
elif [ -n "$ANTHROPIC_API_KEY" ] && [ "$CLAUDE_CODE_USE_BEDROCK" != "1" ]; then
    mode="Anthropic API"
elif [ -n "$GOOGLE_CLOUD_PROJECT" ] || [ -n "$GOOGLE_LOCATION" ]; then
    mode="Vertex AI"
elif [ "$CLAUDE_CODE_USE_BEDROCK" = "0" ]; then
    mode="Claude Pro Plan"
else
    mode="Default (likely Claude Pro Plan)"
fi

print_success "Current mode: $mode"
echo ""

# Display relevant environment variables based on mode
case "$mode" in
    "AWS Bedrock")
        print_status "AWS Bedrock Configuration:"
        print_status "  CLAUDE_CODE_USE_BEDROCK: ${CLAUDE_CODE_USE_BEDROCK}"
        print_status "  AWS_REGION: ${AWS_REGION:-not set}"
        print_status "  AWS_BEARER_TOKEN_BEDROCK: ${AWS_BEARER_TOKEN_BEDROCK:+set (hidden)}"
        print_status "  CLAUDE_CODE_MAX_OUTPUT_TOKENS: ${CLAUDE_CODE_MAX_OUTPUT_TOKENS:-not set}"
        print_status "  MAX_THINKING_TOKENS: ${MAX_THINKING_TOKENS:-not set}"
        print_status "  ANTHROPIC_MODEL: ${ANTHROPIC_MODEL:-not set}"
        echo ""
        print_status "Features:"
        print_status "  - API authentication via AWS Bedrock"
        print_status "  - Login/logout disabled"
        print_status "  - Prompt caching available"
        ;;
    
    "Vertex AI")
        print_status "Vertex AI Configuration:"
        print_status "  CLAUDE_CODE_USE_BEDROCK: ${CLAUDE_CODE_USE_BEDROCK:-0}"
        print_status "  GOOGLE_CLOUD_PROJECT: ${GOOGLE_CLOUD_PROJECT:-not set}"
        print_status "  GOOGLE_LOCATION: ${GOOGLE_LOCATION:-not set}"
        print_status "  ANTHROPIC_MODEL: ${ANTHROPIC_MODEL:-not set}"
        echo ""
        # Check if gcloud is configured
        if command -v gcloud &> /dev/null; then
            gcloud_account=$(gcloud config get-value account 2>/dev/null)
            if [ -n "$gcloud_account" ]; then
                print_status "Google Cloud Authentication:"
                print_status "  - Authenticated as: $gcloud_account"
            else
                print_warning "  - Not authenticated with gcloud"
            fi
        else
            print_warning "  - gcloud CLI not found"
        fi
        echo ""
        print_status "Features:"
        print_status "  - API authentication via Google Vertex AI"
        print_status "  - Uses Application Default Credentials"
        print_status "  - Login/logout disabled"
        ;;
    
    "Anthropic API")
        print_status "Anthropic API Configuration:"
        print_status "  CLAUDE_CODE_USE_BEDROCK: ${CLAUDE_CODE_USE_BEDROCK:-0}"
        print_status "  ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:+set (hidden)}"
        print_status "  ANTHROPIC_MODEL: ${ANTHROPIC_MODEL:-not set}"
        echo ""
        print_status "Features:"
        print_status "  - API authentication via Anthropic API"
        print_status "  - Login/logout disabled"
        print_status "  - Direct access to Anthropic models"
        ;;
    
    "Claude Pro Plan"|"Default (likely Claude Pro Plan)")
        print_status "Claude Pro Plan Configuration:"
        print_status "  CLAUDE_CODE_USE_BEDROCK: ${CLAUDE_CODE_USE_BEDROCK:-not set}"
        echo ""
        print_status "Features:"
        print_status "  - Web authentication via Claude Pro"
        print_status "  - Login/logout enabled"
        print_status "  - Subject to subscription usage limits"
        ;;
esac

echo ""
print_status "Available commands:"
print_status "  claude-pro          - Switch to Claude Pro Plan mode"
print_status "  claude-aws          - Switch to AWS Bedrock mode"
print_status "  claude-vertex       - Switch to Google Vertex AI mode"
print_status "  claude-anthropic    - Switch to Anthropic API mode"
print_status "  claude-status       - Show current configuration"
print_status "  claude-sessions     - List active Claude sessions"
echo ""
